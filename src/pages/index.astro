---
import Layout from "../layouts/Layout.astro";
import { Container } from "../components/Container";
---

<Layout title="Client">
  <section class="flex flex-col items-center justify-center h-screen">
    <Container id="container">
      <h2 class="text-4xl">PRUEBAS</h2>

      <p class="flex flex-col">
        <span id="name">Nombre: </span>
        <span id="token">Token: </span>
      </p>

      <a
        id="login"
        class="min-w-48 p-3 border-[1px] rounded-xl border-gray-500 text-center"
        href="http://localhost:3000/login">Login</a
      >
      <button
        id="policy"
        class="min-w-48 p-3 border-[1px] rounded-xl border-gray-500 text-center"
        >Obtener p√≥lizas</button
      >
    </Container>
  </section>
</Layout>

<script>
  import { getPolicyByRut } from "../services/getPolicyByRut";

  const SSO_NEXT = import.meta.env.PUBLIC_SSO_NEXT;

  const container = document.getElementById("container");
  const loginButton = document.getElementById("login");
  const policyButton = document.getElementById("policy");
  const name = document.getElementById("name");
  const token = document.getElementById("token");

  document.addEventListener("DOMContentLoaded", () => {
    loginButton?.addEventListener("click", (e) => {
      e.preventDefault();
      if (typeof window !== "undefined") {
        window.location.href = SSO_NEXT;
      }
    });

    policyButton?.addEventListener("click", async () => {
      const elementId = "error-message";
      const previousNode = document.getElementById(elementId);

      getPolicyByRut("")
        .then(async (response) => {
          console.log(response);
          if (previousNode) previousNode.remove();

          // Confetti
          // const JSConfetti = await import("js-confetti").then(
          //     (module) => module.default
          //   );
          //   const jsConfetti = new JSConfetti();
          //   jsConfetti.addConfetti();
        })
        .catch((error: any) => {
          if (!error) return;
          if (previousNode) previousNode.remove();

          const p = document.createElement("p");
          p.id = elementId;
          p.style.color = "red";
          p.innerHTML = "Verifique su identidad";
          p.style.textAlign = "center";

          container && container.appendChild(p);
        });
    });
  });
</script>
